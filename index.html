<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parked Car Locator</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg:#0b1220; /* deep navy */
      --card:#141c2b;
      --muted:#9fb0c3;
      --accent:#5bbcff;
      --accent-2:#8effa3;
      --danger:#ff6b6b;
      --ok:#89ffef;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:#eaf2ff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display:flex; flex-direction:column;
    }
    header{
      text-align:center; padding:12px 12px 4px; position:sticky; top:0; z-index:1000; background:linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.92)); backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    h1{font-size:20px; margin:6px 0 2px}
    .sub{font-size:12px; color:var(--muted)}
    #map{height:46vh; min-height:260px; width:100%}

    .grid{display:grid; gap:10px; padding:12px}
    @media(min-width:760px){
      .grid{grid-template-columns:1.2fr 1fr}
      #map{height:55vh}
    }

    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    button, input[type="number"], input[type="text"], textarea{
      font:inherit; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0e1624; color:#eaf2ff; padding:10px 12px;
    }
    button{cursor:pointer; border-color:transparent; background:linear-gradient(180deg,#1b8fff,#1462ff); box-shadow:0 6px 20px rgba(20,98,255,.25);}
    button.secondary{background:#12223a; border:1px solid rgba(255,255,255,.12); box-shadow:none}
    button.warn{background:linear-gradient(180deg,#ff7b7b,#e05252)}
    button:disabled{opacity:.6; cursor:not-allowed}

    .stack{display:grid; gap:8px}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:6px; align-items:center}
    .muted{color:var(--muted)}
    .big{font-size:28px; font-weight:700}

    .compass{display:flex; align-items:center; gap:14px}
    .needle{width:48px; height:48px; border-radius:50%; border:1px solid rgba(255,255,255,.1); display:inline-grid; place-items:center; position:relative; background:#0f1a2b}
    .needle::after{content:""; width:2px; height:20px; background:var(--accent); position:absolute; top:8px; left:50%; transform:translateX(-50%)}

    .photo-preview{max-width:100%; max-height:180px; display:block; margin-top:6px; border-radius:10px; border:1px solid rgba(255,255,255,.08)}

    footer{padding:10px; text-align:center; color:var(--muted); font-size:12px}
    a{color:var(--ok)}
  </style>
</head>
<body>
  <header>
    <h1>üöó Parked Car Locator</h1>
    <div class="sub">Save where you parked, then get distance, direction, map & notes.</div>
  </header>

  <div id="map"></div>

  <div class="grid">
    <section class="card stack" aria-label="Actions">
      <div class="row">
        <button id="btnLocate">üìç Update My Position</button>
        <button id="btnPark">üÖøÔ∏è Park Here</button>
        <button id="btnRoute" class="secondary" disabled>üó∫Ô∏è Route</button>
        <button id="btnShare" class="secondary" disabled>üîó Share</button>
        <button id="btnClear" class="warn" disabled>üóëÔ∏è Clear</button>
      </div>

      <div class="kv">
        <div class="muted">Status</div>
        <div id="status">Waiting for location‚Ä¶</div>
        <div class="muted">Distance</div>
        <div><span id="distance" class="big">‚Äî</span> <span class="muted" id="units">m</span></div>
        <div class="muted">Bearing</div>
        <div id="bearing">‚Äî</div>
      </div>

      <div class="compass">
        <div class="needle" id="needle" title="Points toward your car"></div>
        <small class="muted">Rotate your phone. Arrow uses device compass; enable motion/compass permissions if prompted.</small>
      </div>

      <div class="stack">
        <label class="muted">Note (e.g., P2, Blue Zone, near elevator)</label>
        <input type="text" id="note" placeholder="Optional note about the spot" />
        <label class="muted">Photo (optional)</label>
        <input type="file" id="photo" accept="image/*" capture="environment" />
        <img id="photoPreview" class="photo-preview" alt="Photo preview" hidden>
      </div>

      <div class="row">
        <label class="muted" for="mins">Parking timer:</label>
        <input type="number" id="mins" min="0" step="5" value="0" style="width:120px" />
        <button id="btnStartTimer" class="secondary">Start/Update</button>
        <span class="muted" id="timerText">No timer set.</span>
      </div>
    </section>

    <section class="card stack" aria-label="Saved details">
      <div class="kv">
        <div class="muted">Last parked</div>
        <div id="parkedAt">‚Äî</div>
        <div class="muted">Coordinates</div>
        <div id="coords">‚Äî</div>
        <div class="muted">Saved note</div>
        <div id="savedNote">‚Äî</div>
      </div>
      <div id="savedPhotoWrap" class="stack" hidden>
        <label class="muted">Saved photo</label>
        <img id="savedPhoto" class="photo-preview" alt="Saved parking photo" />
      </div>
      <small class="muted">Tips: Works best on HTTPS (for GPS & compass). If map tiles don‚Äôt load (offline), distance/arrow still work.</small>
    </section>
  </div>

  <footer>
    ¬© <span id="yr"></span> Parked Car Locator ¬∑ Uses OpenStreetMap/Leaflet
  </footer>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // --- Utilities ---
    const $ = (s)=>document.querySelector(s);
    const fmt = (n)=> new Intl.NumberFormat(undefined, {maximumFractionDigits: n>=1000?0:1}).format(n);
    const toRad = (d)=> d*Math.PI/180; const toDeg = (r)=> r*180/Math.PI;
    const haversine = (a,b)=>{ // meters
      const R=6371e3; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    };
    const initialBearing = (a,b)=>{ // degrees 0..360
      const œÜ1=toRad(a.lat), œÜ2=toRad(b.lat), Œª1=toRad(a.lng), Œª2=toRad(b.lng);
      const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2);
      const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
      return (toDeg(Math.atan2(y,x))+360)%360;
    };
    const store = {
      get(){ try{ return JSON.parse(localStorage.getItem('parked_car_v1')||'null'); }catch{ return null } },
      set(v){ localStorage.setItem('parked_car_v1', JSON.stringify(v)); },
      clear(){ localStorage.removeItem('parked_car_v1'); }
    };

    // --- State ---
    let me = null; // {lat,lng, accuracy}
    let parked = store.get();
    let map, meMarker, parkedMarker, accuracyCircle;
    let desiredBearing = null; // bearing to car

    // --- Map ---
    function initMap(){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      meMarker = L.marker([0,0], {title:'You'});
      parkedMarker = L.marker([0,0], {title:'Car', opacity:0.9, draggable:false});
      accuracyCircle = L.circle([0,0], {radius:5, weight:1, color:'#5bbcff', fillOpacity:0.08});
      meMarker.addTo(map); accuracyCircle.addTo(map);
      if(parked){ parkedMarker.addTo(map); }
      fitView();
    }

    function fitView(){
      const layers=[];
      if(me){ layers.push([me.lat, me.lng]); }
      if(parked){ layers.push([parked.lat, parked.lng]); }
      if(layers.length){ map.fitBounds(layers, {padding:[40,40]}); }
      else{ map.setView([43.6532,-79.3832], 13); } // Toronto fallback
    }

    // --- Geolocation ---
    async function locate(){
      setStatus('Locating‚Ä¶');
      if(!('geolocation' in navigator)) return setStatus('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lng, accuracy} = pos.coords;
        me = {lat,lng,accuracy};
        meMarker.setLatLng([lat,lng]);
        accuracyCircle.setLatLng([lat,lng]).setRadius(accuracy||10);
        setStatus(`Location updated (${Math.round(accuracy)} m accuracy)`);
        updateDistanceAndBearing();
        if(!map) return; if(!map._loaded) return; // safety
        if(!parked) map.setView([lat,lng], Math.max(map.getZoom(), 16));
      }, err=>{
        setStatus('Location error: ' + err.message);
      }, {enableHighAccuracy:true, timeout:15000, maximumAge:10000});
    }

    // --- Parking ---
    function parkHere(){
      if(!me){ alert('Get your current position first.'); return; }
      const note = $('#note').value.trim();
      const photoEl = $('#photo');
      const now = new Date().toISOString();
      const save = (photoData)=>{
        parked = {lat:me.lat, lng:me.lng, at:now, note:note||null, photo:photoData||null, timer:null};
        store.set(parked);
        parkedMarker.addTo(map).setLatLng([parked.lat, parked.lng]);
        refreshSavedUI();
        setStatus('Parked location saved.');
        updateDistanceAndBearing();
        $('#btnRoute').disabled = false;
        $('#btnShare').disabled = false;
        $('#btnClear').disabled = false;
      };
      if(photoEl.files && photoEl.files[0]){
        const file = photoEl.files[0];
        const reader = new FileReader();
        reader.onload = ()=> save(reader.result);
        reader.onerror = ()=> save(null);
        reader.readAsDataURL(file);
      } else save(null);
    }

    function clearParking(){
      if(!parked){ return; }
      if(!confirm('Clear saved parking location?')) return;
      store.clear(); parked = null; desiredBearing=null;
      $('#parkedAt').textContent = '‚Äî';
      $('#coords').textContent = '‚Äî';
      $('#savedNote').textContent = '‚Äî';
      $('#savedPhotoWrap').hidden = true;
      $('#btnRoute').disabled = true; $('#btnShare').disabled = true; $('#btnClear').disabled = true;
      if(map && parkedMarker){ parkedMarker.remove(); }
      setStatus('Cleared.');
      updateDistanceAndBearing();
      fitView();
    }

    function refreshSavedUI(){
      if(!parked){ return; }
      const dt = new Date(parked.at);
      $('#parkedAt').textContent = dt.toLocaleString();
      $('#coords').textContent = `${parked.lat.toFixed(6)}, ${parked.lng.toFixed(6)}`;
      $('#savedNote').textContent = parked.note || '‚Äî';
      if(parked.photo){ $('#savedPhoto').src = parked.photo; $('#savedPhotoWrap').hidden = false; }
      else { $('#savedPhotoWrap').hidden = true; }
    }

    // --- Distance / Bearing / Compass ---
    function updateDistanceAndBearing(){
      if(me && parked){
        const d = haversine(me, parked); // meters
        $('#distance').textContent = d>1000? fmt(d/1000): fmt(d);
        $('#units').textContent = d>1000? 'km':'m';
        const brg = initialBearing(me, parked);
        $('#bearing').textContent = Math.round(brg) + '¬∞';
        desiredBearing = brg;
      } else { $('#distance').textContent = '‚Äî'; $('#bearing').textContent='‚Äî'; }
      rotateNeedle();
    }

    function rotateNeedle(deviceHeading){
      const el = $('#needle');
      if(desiredBearing==null){ el.style.transform='rotate(0deg)'; return; }
      // If we have a device heading, rotate to (desired - deviceHeading). Otherwise, just show desired.
      let rot = desiredBearing;
      if(typeof deviceHeading === 'number' && !Number.isNaN(deviceHeading)) rot = (desiredBearing - deviceHeading + 360)%360;
      el.style.transform = `rotate(${rot}deg)`;
    }

    async function enableCompass(){
      const permNeeded = typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function';
      try{
        if(permNeeded){
          const r = await DeviceOrientationEvent.requestPermission();
          if(r !== 'granted'){ return; }
        }
      }catch{}
      window.addEventListener('deviceorientationabsolute', e=>{
        const heading = (typeof e.alpha === 'number') ? (360 - e.alpha) % 360 : null; // alpha: degrees cw from device top pointing north; convert to compass heading
        rotateNeedle(heading);
      });
      window.addEventListener('deviceorientation', e=>{
        const heading = (typeof e.alpha === 'number') ? (360 - e.alpha) % 360 : null;
        rotateNeedle(heading);
      });
    }

    // --- Routes & Share ---
    function openRoute(){
      if(!parked) return;
      const url = `https://www.google.com/maps/dir/?api=1&destination=${parked.lat},${parked.lng}`;
      window.open(url, '_blank');
    }
    async function shareLoc(){
      if(!parked) return;
      const text = `My parked car at ${parked.lat.toFixed(6)}, ${parked.lng.toFixed(6)}${parked.note? ' ‚Äî '+parked.note:''}`;
      const url = `https://maps.google.com/?q=${parked.lat},${parked.lng}`;
      if(navigator.share){ try{ await navigator.share({title:'Parked Car', text, url}); }catch{} }
      else { prompt('Copy link:', url); }
    }

    // --- Timer ---
    let timerInterval = null;
    function startTimer(){
      const mins = parseInt($('#mins').value,10);
      if(!parked){ alert('Save a parked location first.'); return; }
      if(!Number.isFinite(mins) || mins<=0){ parked.timer=null; store.set(parked); $('#timerText').textContent='No timer set.'; if(timerInterval) clearInterval(timerInterval); return; }
      const now = Date.now();
      parked.timer = {start: now, minutes: mins};
      store.set(parked);
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerText, 1000);
      updateTimerText();
    }
    function updateTimerText(){
      if(!parked || !parked.timer){ $('#timerText').textContent='No timer set.'; return; }
      const end = parked.timer.start + parked.timer.minutes*60000;
      const rem = Math.max(0, end - Date.now());
      const mm = Math.floor(rem/60000), ss = Math.floor((rem%60000)/1000);
      $('#timerText').textContent = rem>0 ? `Time left: ${mm}:${String(ss).padStart(2,'0')}` : '‚è∞ Timer finished';
      if(rem<=0 && timerInterval){ clearInterval(timerInterval); timerInterval=null; alert('Parking timer finished.'); }
    }

    // --- UI helpers ---
    function setStatus(t){ $('#status').textContent = t; }

    // --- Events ---
    window.addEventListener('load', ()=>{
      $('#yr').textContent = new Date().getFullYear();
      initMap();
      locate();
      enableCompass();

      if(parked){
        refreshSavedUI();
        $('#btnRoute').disabled = false; $('#btnShare').disabled = false; $('#btnClear').disabled = false;
        parkedMarker.setLatLng([parked.lat, parked.lng]).addTo(map);
        updateTimerText();
      }

      $('#btnLocate').addEventListener('click', locate);
      $('#btnPark').addEventListener('click', parkHere);
      $('#btnRoute').addEventListener('click', openRoute);
      $('#btnShare').addEventListener('click', shareLoc);
      $('#btnClear').addEventListener('click', clearParking);
      $('#btnStartTimer').addEventListener('click', startTimer);

      // When user changes selected photo, preview it
      $('#photo').addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f){ $('#photoPreview').hidden=true; return; }
        const reader = new FileReader();
        reader.onload = ()=>{ $('#photoPreview').src=reader.result; $('#photoPreview').hidden=false; };
        reader.readAsDataURL(f);
      });

      // Recompute distance/bearing periodically and on move (in case user walks)
      setInterval(()=>{ if(me) updateDistanceAndBearing(); }, 4000);
    });
  </script>
</body>
</html>
